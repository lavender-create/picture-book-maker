<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚ˆã¿ãã‹ã›</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="btn" href="/select">â† ã‚‚ã©ã‚‹</a>
      <a class="btn" href="/">ğŸ  ãƒˆãƒƒãƒ—</a>
    </div>

    <h1 class="page-title" id="storyTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>

    <div class="cover">
      <img id="coverImg" class="cover-img" alt="">
      <div class="status" id="statusBox"></div>
      <div class="controls" style="margin-top:10px;">
        <button class="btn soft" id="regenCoverBtn" type="button">ğŸ–¼ ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆ</button>
      </div>
    </div>

    <div class="line" id="lineBox">â€¦</div>

    <div class="controls">
      <button class="btn primary" id="readBtn" type="button">ğŸ“– ã‚ˆã‚€ï¼ˆæ–‡å­—ã ã‘ï¼‰</button>
      <button class="btn auto" id="autoBtn" type="button">â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF</button>
      <button class="btn" id="stopBtn" type="button">â¹ ã¨ã‚ã‚‹</button>
    </div>

    <div class="small">ã˜ã©ã†ã®ã¨ãã ã‘éŸ³å£°ãŒå‡ºã¾ã™ï¼ˆå£°ï¼šnovaï¼‰</div>
  </div>

  <script src="/static/js/stories.js"></script>
  <script>
    // theme ã®æ±ºå®šï¼ˆURLå„ªå…ˆ â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const u = new URL(location.href);
    const THEME = u.searchParams.get("theme") || ("{{ theme }}" || "").trim() || "red";

    const titleEl = document.getElementById("storyTitle");
    const coverImg = document.getElementById("coverImg");
    const statusBox = document.getElementById("statusBox");
    const lineBox  = document.getElementById("lineBox");
    const readBtn  = document.getElementById("readBtn");
    const autoBtn  = document.getElementById("autoBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const regenCoverBtn = document.getElementById("regenCoverBtn");

    let idx = 0;
    let autoMode = false;
    let currentAudio = null;

    function setStatus(msg, kind=""){
      statusBox.className = "status " + kind;
      statusBox.textContent = msg || "";
    }

    function stopAudio(){
      if(currentAudio){
        currentAudio.pause();
        currentAudio = null;
      }
    }

    function getStory(){
      const all = window.STORIES || null;
      if(!all) return null;
      return all[THEME] || null;
    }

    function clampIndex(s){
      if(!s) return 0;
      if(idx < 0) idx = 0;
      if(idx > s.lines.length - 1) idx = s.lines.length - 1;
      return idx;
    }

    function render(){
      const s = getStory();
      if(!s){
        titleEl.textContent = "æº–å‚™ä¸­";
        coverImg.src = "/static/img/red_cover.png";
        lineBox.textContent = "stories.js ãŒèª­ã¿è¾¼ã‚ã¦ã„ãªã„ã‹ã€theme åãŒé•ã„ã¾ã™ã€‚";
        setStatus("theme=" + THEME, "ng");
        return;
      }
      titleEl.textContent = s.title;
      coverImg.src = (s.image || ("/static/img/" + THEME + "_cover.png")) + "?t=" + Date.now();
      clampIndex(s);
      lineBox.textContent = s.lines[idx];
      setStatus("");
    }

    // âœ… æ–‡å­—ã ã‘ã§å¿…ãšé€²ã‚€
    function nextLineTextOnly(){
      const s = getStory();
      if(!s){
        setStatus("ãŠã¯ãªã—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆtheme=" + THEME + "ï¼‰", "ng");
        return;
      }

      autoMode = false;
      autoBtn.textContent = "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF";
      stopAudio();

      if(idx < s.lines.length - 1){
        idx++;
        render();
      }else{
        location.href = "/story_end?theme=" + encodeURIComponent(THEME);
      }
    }

    // âœ… è‡ªå‹•éŸ³å£°
    async function playAutoLine(){
      const s = getStory();
      if(!s) return;

      stopAudio();
      const text = s.lines[idx];

      const res = await fetch("/tts", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text })
      });

      if(!res.ok){
        autoMode = false;
        autoBtn.textContent = "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF";
        setStatus("èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼", "ng");
        return;
      }

      const blob = await res.blob();
      const audioUrl  = URL.createObjectURL(blob);

      const a = new Audio(audioUrl);
      currentAudio = a;

      a.onended = () => {
        URL.revokeObjectURL(audioUrl);
        if(currentAudio === a) currentAudio = null;

        if(autoMode){
          if(idx < s.lines.length - 1){
            idx++;
            render();
            playAutoLine();
          }else{
            autoMode = false;
            autoBtn.textContent = "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF";
            location.href = "/story_end?theme=" + encodeURIComponent(THEME);
          }
        }
      };

      a.play();
    }

    readBtn.addEventListener("click", nextLineTextOnly);

    autoBtn.addEventListener("click", () => {
      const s = getStory();
      if(!s){
        setStatus("ãŠã¯ãªã—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆtheme=" + THEME + "ï¼‰", "ng");
        return;
      }

      autoMode = !autoMode;
      autoBtn.textContent = autoMode ? "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šON" : "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF";
      setStatus("");

      if(autoMode){
        playAutoLine();
      }else{
        stopAudio();
      }
    });

    stopBtn.addEventListener("click", () => {
      autoMode = false;
      autoBtn.textContent = "â–¶ ã˜ã©ã†ï¼ˆéŸ³å£°ï¼‰ï¼šOFF";
      stopAudio();
    });

    regenCoverBtn.addEventListener("click", async () => {
      regenCoverBtn.disabled = true;
      setStatus("ç”»åƒã‚’ä½œã£ã¦ã„ã¾ã™â€¦");

      try{
        const res = await fetch("/api/generate_cover", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ theme: THEME })
        });
        const j = await res.json().catch(()=>null);

        if(!res.ok || !j || !j.ok){
          const msg = (j && j.error) ? j.error : ("HTTP " + res.status);
          setStatus("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + msg, "ng");
          return;
        }
        coverImg.src = j.path + "?t=" + Date.now();
        setStatus("ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸ âœ…", "ok");
      }catch(e){
        setStatus("ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + String(e), "ng");
      }finally{
        regenCoverBtn.disabled = false;
      }
    });

    // stories.js ã®èª­ã¿è¾¼ã¿ãŒé…ã„å ´åˆã§ã‚‚å‹•ãã‚ˆã†ã«å°‘ã—å¾…ã£ã¦æç”»
    setTimeout(render, 0);
    setTimeout(render, 200);
  </script>
</body>
</html>
